{% extends "base.html" %}
{% load static %}

{% block title %}{% if student_user %}Редактирование ученика{% else %}Добавление ученика{% endif %}{% endblock %}

{% block content %}
<div class="admin-container">
    {% include "includes/sidebar.html" %}
    
    <main class="main-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="font-size: 24px; font-weight: 600; margin: 0;">
                {% if student_user %}
                Редактирование ученика: {{ student_user.get_full_name }}
                {% else %}
                Добавление нового ученика
                {% endif %}
            </h1>
            <a href="{% url 'students_list' %}" class="btn btn-outline" style="display: flex; align-items: center; gap: 5px;">
                <i class="bi bi-arrow-left"></i> Назад
            </a>
        </div>

        <div style="display: flex; gap: 30px;">
            <!-- Левая колонка - форма (70%) -->
            <div style="flex: 0 0 70%;">
                <div class="card">
                    <div class="card-body">
                        <form method="post" id="studentForm">
                            {% csrf_token %}
                            
                            <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                                <!-- Личные данные -->
                                <div style="width: 100%;">
                                    <h4 style="font-size: 16px; font-weight: 500; color: var(--text-secondary); margin: 0 0 15px 0; padding-bottom: 5px; border-bottom: 1px solid var(--border);">Личные данные</h4>
                                </div>
                                
                                <div style="flex: 1 1 calc(50% - 10px); min-width: 250px;">
                                    <div class="form-group">
                                        <label class="form-label">Фамилия *</label>
                                        <input type="text" name="last_name" class="form-control" value="{{ student_user.last_name|default:'' }}" required>
                                    </div>
                                </div>
                                
                                <div style="flex: 1 1 calc(50% - 10px); min-width: 250px;">
                                    <div class="form-group">
                                        <label class="form-label">Имя *</label>
                                        <input type="text" name="first_name" class="form-control" value="{{ student_user.first_name|default:'' }}" required>
                                    </div>
                                </div>
                                
                                <div style="flex: 1 1 calc(50% - 10px); min-width: 250px;">
                                    <div class="form-group">
                                        <label class="form-label">Отчество *</label>
                                        <input type="text" name="patronymic" class="form-control" value="{{ student_profile.patronymic|default:'' }}" required>
                                    </div>
                                </div>
                                
                                <div style="flex: 1 1 calc(50% - 10px); min-width: 250px;">
                                    <div class="form-group">
                                        <label class="form-label">Дата рождения</label>
                                        <input type="date" name="birth_date" class="form-control" value="{{ student_profile.birth_date|date:'Y-m-d'|default:'' }}">
                                    </div>
                                </div>

                                <!-- Контактная информация -->
                                <div style="width: 100%; margin-top: 10px;">
                                    <h4 style="font-size: 16px; font-weight: 500; color: var(--text-secondary); margin: 0 0 15px 0; padding-bottom: 5px; border-bottom: 1px solid var(--border);">Контактная информация</h4>
                                </div>
                                
                                <div style="flex: 1 1 calc(50% - 10px); min-width: 250px;">
                                    <div class="form-group">
                                        <label class="form-label">Email</label>
                                        <input type="email" name="email" class="form-control" value="{{ student_user.email|default:'' }}" placeholder="email@example.com">
                                    </div>
                                </div>
                                
                                <div style="flex: 1 1 calc(50% - 10px); min-width: 250px;">
                                    <div class="form-group">
                                        <label class="form-label">Телефон</label>
                                        <input type="tel" name="phone" class="form-control" value="{{ student_profile.phone|default:'' }}" placeholder="+7 (999) 123-45-67">
                                    </div>
                                </div>
                                
                                <div style="width: 100%;">
                                    <div class="form-group">
                                        <label class="form-label">Адрес</label>
                                        <input type="text" name="address" class="form-control" value="{{ student_profile.address|default:'' }}" placeholder="Город, улица, дом">
                                    </div>
                                </div>

                                <!-- Учебная информация -->
                                <div style="width: 100%; margin-top: 10px;">
                                    <h4 style="font-size: 16px; font-weight: 500; color: var(--text-secondary); margin: 0 0 15px 0; padding-bottom: 5px; border-bottom: 1px solid var(--border);">Учебная информация</h4>
                                </div>
                                
                                <div style="flex: 1 1 calc(50% - 10px); min-width: 250px;">
                                    <div class="form-group">
                                        <label class="form-label">Курс *</label>
                                        <select name="course" id="course" class="form-control" required>
                                            <option value="">Выберите курс</option>
                                            <option value="1" {% if student_profile.course == 1 %}selected{% endif %}>1 курс</option>
                                            <option value="2" {% if student_profile.course == 2 %}selected{% endif %}>2 курс</option>
                                            <option value="3" {% if student_profile.course == 3 %}selected{% endif %}>3 курс</option>
                                            <option value="4" {% if student_profile.course == 4 %}selected{% endif %}>4 курс</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="flex: 1 1 calc(50% - 10px); min-width: 250px;">
                                    <div class="form-group">
                                        <label class="form-label">Группа</label>
                                        <select name="group" id="group" class="form-control">
                                            <option value="">Без группы</option>
                                            {% for group in groups %}
                                            <option value="{{ group.id }}" data-year="{{ group.year }}" {% if student_profile.student_group.id == group.id %}selected{% endif %}>
                                                {{ group.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <div class="form-hint" id="groupHint">Выберите курс для фильтрации групп</div>
                                    </div>
                                </div>

                                <!-- Учетные данные -->
                                <div style="width: 100%; margin-top: 10px;">
                                    <h4 style="font-size: 16px; font-weight: 500; color: var(--text-secondary); margin: 0 0 15px 0; padding-bottom: 5px; border-bottom: 1px solid var(--border);">Учетные данные</h4>
                                </div>
                                
                                <div style="flex: 1 1 calc(50% - 10px); min-width: 250px;">
                                    <div class="form-group">
                                        <label class="form-label">Логин *</label>
                                        <input type="text" name="username" class="form-control" value="{{ student_user.username|default:'' }}" required>
                                    </div>
                                </div>
                                
                                <div style="flex: 1 1 calc(50% - 10px); min-width: 250px;">
                                    <div class="form-group">
                                        <label class="form-label">{% if student_user %}Новый пароль{% else %}Пароль *{% endif %}</label>
                                        <input type="password" name="password" class="form-control" {% if not student_user %}required{% endif %} placeholder="минимум 6 символов">
                                    </div>
                                </div>
                                
                                <div style="flex: 1 1 calc(50% - 10px); min-width: 250px;">
                                    <div class="form-group">
                                        <label class="form-label">Подтверждение</label>
                                        <input type="password" name="confirm_password" class="form-control" {% if not student_user %}required{% endif %} placeholder="повторите пароль">
                                    </div>
                                </div>
                                
                                <div style="width: 100%;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" name="is_active" id="is_active" class="form-checkbox" {% if student_user.is_active or not student_user %}checked{% endif %}>
                                        <label for="is_active" class="form-label" style="margin: 0;">Активный аккаунт</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle"></i>
                                    {% if student_user %}Сохранить изменения{% else %}Добавить ученика{% endif %}
                                </button>
                                <a href="{% url 'students_list' %}" class="btn btn-outline">
                                    Отмена
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Правая колонка - информация (30%) -->
            <div style="flex: 0 0 30%;">
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body">
                        <h4 style="font-size: 16px; font-weight: 500; margin: 0 0 15px 0; color: var(--text);">Правила добавления</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; align-items: flex-start; gap: 8px;">
                                <i class="bi bi-info-circle" style="color: #3b82f6; font-size: 16px;"></i>
                                <span style="font-size: 13px; color: var(--text-secondary);">Группа должна соответствовать курсу ученика</span>
                            </div>
                            <div style="display: flex; align-items: flex-start; gap: 8px;">
                                <i class="bi bi-asterisk" style="color: var(--danger); font-size: 16px;"></i>
                                <span style="font-size: 13px; color: var(--text-secondary);">Поля отмеченные * обязательны для заполнения</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <h4 style="font-size: 16px; font-weight: 500; margin: 0 0 15px 0; color: var(--text);">Предварительный просмотр</h4>
                        <div id="preview" style="min-height: 100px; padding: 15px; background: rgba(0,0,0,0.02); border-radius: 6px; border: 1px solid var(--border);">
                            <span style="color: var(--text-secondary); font-size: 13px;">Заполните форму для предпросмотра</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const courseSelect = document.getElementById('course');
    const groupSelect = document.getElementById('group');
    const groupHint = document.getElementById('groupHint');
    const previewDiv = document.getElementById('preview');
    
    // Получаем значения полей
    const lastName = document.querySelector('input[name="last_name"]');
    const firstName = document.querySelector('input[name="first_name"]');
    const patronymic = document.querySelector('input[name="patronymic"]');
    
    // Фильтрация групп по курсу
    function filterGroups() {
        const selectedCourse = courseSelect.value;
        
        if (!selectedCourse) {
            // Показываем все группы
            Array.from(groupSelect.options).forEach(option => {
                option.style.display = '';
            });
            groupHint.textContent = 'Выберите курс для фильтрации групп';
            groupHint.style.color = 'var(--text-secondary)';
            updatePreview();
            return;
        }
        
        let hasGroups = false;
        Array.from(groupSelect.options).forEach(option => {
            if (option.value === '') return;
            
            const groupYear = option.getAttribute('data-year');
            if (groupYear === selectedCourse) {
                option.style.display = '';
                hasGroups = true;
            } else {
                option.style.display = 'none';
            }
        });
        
        if (hasGroups) {
            groupHint.textContent = `Доступные группы для ${selectedCourse} курса`;
            groupHint.style.color = 'var(--success)';
        } else {
            groupHint.textContent = `Нет групп для ${selectedCourse} курса`;
            groupHint.style.color = 'var(--danger)';
        }
        
        updatePreview();
    }
    
    // Обновление предпросмотра
    function updatePreview() {
        const fullName = `${lastName.value || ''} ${firstName.value || ''} ${patronymic.value || ''}`.trim();
        const course = courseSelect.value;
        const group = groupSelect.options[groupSelect.selectedIndex]?.text || '';
        
        let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
        
        if (fullName) {
            html += `
                <div>
                    <span style="color: var(--text-secondary); font-size: 12px;">ФИО:</span>
                    <div style="font-weight: 500; font-size: 14px;">${fullName}</div>
                </div>
            `;
        }
        
        if (course) {
            html += `
                <div>
                    <span style="color: var(--text-secondary); font-size: 12px;">Курс:</span>
                    <div style="font-size: 14px;">${course} курс</div>
                </div>
            `;
        }
        
        if (group && group !== 'Без группы') {
            html += `
                <div>
                    <span style="color: var(--text-secondary); font-size: 12px;">Группа:</span>
                    <div style="font-size: 14px;">${group}</div>
                </div>
            `;
        }
        
        if (!fullName && !course) {
            html = '<span style="color: var(--text-secondary); font-size: 13px;">Заполните форму для предпросмотра</span>';
        }
        
        previewDiv.innerHTML = html;
    }
    
    // Слушаем изменения
    courseSelect.addEventListener('change', filterGroups);
    groupSelect.addEventListener('change', updatePreview);
    lastName.addEventListener('input', updatePreview);
    firstName.addEventListener('input', updatePreview);
    patronymic.addEventListener('input', updatePreview);
    
    // Инициализация
    if (courseSelect.value) {
        filterGroups();
    }
    
    // Валидация формы
    document.getElementById('studentForm').addEventListener('submit', function(e) {
        const selectedGroup = groupSelect.options[groupSelect.selectedIndex];
        if (selectedGroup && selectedGroup.value) {
            if (selectedGroup.style.display === 'none') {
                e.preventDefault();
                alert('Выбранная группа не соответствует курсу!');
                groupSelect.focus();
            }
        }
    });
});
</script>
{% endblock %}