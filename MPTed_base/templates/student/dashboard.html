{% extends "base.html" %}
{% load static %}

{% block title %}Панель студента - MPTed{% endblock %}

{% block extra_css %}
<style>
    /* Стили для нового макета */
    .stats-grid-compact {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card-compact {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s;
    }
    
    .stat-card-compact:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .dark-theme .stat-card-compact:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .stat-value-compact {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.5rem;
    }
    
    .stat-value-compact.grade-excellent { color: #28a745; }
    .stat-value-compact.grade-good { color: #17a2b8; }
    .stat-value-compact.grade-average { color: #ffc107; }
    .stat-value-compact.grade-poor { color: #dc3545; }
    
    .stat-label-compact {
        font-size: 0.875rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--border);
        color: var(--text);
    }
    
    .schedule-today {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .lesson-row {
        display: flex;
        align-items: center;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-radius: 8px;
        background: var(--card);
        border: 1px solid var(--border);
        transition: all 0.2s;
    }
    
    .lesson-row:hover {
        background: rgba(124, 58, 237, 0.05);
        border-color: var(--primary);
    }
    
    .lesson-number {
        width: 60px;
        font-weight: 600;
        color: var(--primary);
        font-size: 1.125rem;
    }
    
    .lesson-subject {
        flex: 1;
        font-weight: 500;
        color: var(--text);
    }
    
    .lesson-teacher {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }
    
    .announcements-container {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .announcement-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.3s;
        cursor: pointer;
    }
    
    .announcement-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: var(--primary);
    }
    
    .dark-theme .announcement-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .announcement-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
    }
    
    .announcement-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.25rem;
    }
    
    .announcement-meta {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }
    
    .announcement-content {
        font-size: 0.875rem;
        line-height: 1.5;
        color: var(--text);
        margin-bottom: 0.75rem;
    }
    
    .announcement-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: var(--text-secondary);
        padding-top: 0.75rem;
        border-top: 1px solid var(--border);
    }
    
    .badge-general {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .badge-class {
        background: rgba(124, 58, 237, 0.1);
        color: var(--primary);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .grades-container {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .grade-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-radius: 8px;
        background: var(--card);
        border: 1px solid var(--border);
        transition: all 0.2s;
    }
    
    .grade-item:hover {
        background: rgba(124, 58, 237, 0.05);
    }
    
    .grade-value {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-weight: 700;
        font-size: 1.125rem;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    
    .grade-value-excellent { background-color: #28a745; color: white; }
    .grade-value-good { background-color: #17a2b8; color: white; }
    .grade-value-average { background-color: #ffc107; color: black; }
    .grade-value-poor { background-color: #dc3545; color: white; }
    
    .grade-info {
        flex: 1;
    }
    
    .grade-subject {
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.25rem;
    }
    
    .grade-details {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }
    
    .grade-teacher {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }
    
    .homework-container {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
    }
    
    .homework-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        margin-bottom: 0.75rem;
        border-radius: 8px;
        background: var(--card);
        border: 1px solid var(--border);
        transition: all 0.3s;
        cursor: pointer;
    }
    
    .homework-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: var(--primary);
        background: rgba(124, 58, 237, 0.05);
    }
    
    .dark-theme .homework-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .homework-icon {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(124, 58, 237, 0.1);
        color: var(--primary);
        border-radius: 10px;
        margin-right: 1rem;
        flex-shrink: 0;
        font-size: 1.25rem;
    }
    
    .homework-content {
        flex: 1;
    }
    
    .homework-title {
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.25rem;
    }
    
    .homework-description {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .homework-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: var(--text-secondary);
    }
    
    .homework-subject {
        background: rgba(124, 58, 237, 0.1);
        color: var(--primary);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-weight: 600;
    }
    
    .homework-deadline {
        font-weight: 500;
    }
    
    .homework-deadline.urgent {
        color: #dc3545;
        font-weight: 600;
    }
    
    .empty-state-custom {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-secondary);
    }
    
    .empty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    
    .empty-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .empty-text {
        font-size: 0.875rem;
        max-width: 300px;
        margin: 0 auto;
    }
    
    .view-all-link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.2s;
    }
    
    .view-all-link:hover {
        color: var(--primary-dark);
    }
    
    @media (max-width: 768px) {
        .stats-grid-compact {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .lesson-row,
        .grade-item,
        .homework-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .lesson-number,
        .grade-value,
        .homework-icon {
            margin-right: 0;
            margin-bottom: 0.5rem;
        }
        
        .announcement-header,
        .homework-meta {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    {% include "student/_sidebar.html" %}

    <main class="main-content">
        <!-- Шапка -->
        <div class="content-header mb-4">
            <div>
                <h1 class="content-title">Добро пожаловать, {{ user.first_name }}!</h1>
                <p class="content-subtitle">
                    {{ student_profile.student_group.name|default:"Не в классе" }}
                    {% if student_profile.course %}- {{ student_profile.course }} курс{% endif %}
                </p>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted">{{ today|date:"d E Y" }}</span>
            </div>
        </div>

        <!-- 1. СТАТИСТИКА - Активные задания и средний балл -->
        <div class="section-title">
            Общая статистика
        </div>
        <div class="stats-grid-compact mb-6">
            <div class="stat-card-compact">
                <div class="stat-value-compact 
                    {% if average_grade >= 4.5 %}grade-excellent
                    {% elif average_grade >= 3.5 %}grade-good
                    {% elif average_grade >= 2.5 %}grade-average
                    {% else %}grade-poor{% endif %}">
                    {{ average_grade|floatformat:1 }}
                </div>
                <div class="stat-label-compact">Средний балл</div>
            </div>
            
            <div class="stat-card-compact">
                <div class="stat-value-compact">{{ homeworks|length }}</div>
                <div class="stat-label-compact">Активные задания</div>
            </div>
            
            <div class="stat-card-compact">
                <div class="stat-value-compact">{{ total_grades }}</div>
                <div class="stat-label-compact">Всего оценок</div>
            </div>
            
            <div class="stat-card-compact">
                <div class="stat-value-compact">{{ subject_count }}</div>
                <div class="stat-label-compact">Предметов</div>
            </div>
        </div>

        <!-- 2. РАСПИСАНИЕ НА СЕГОДНЯ -->
        <div class="schedule-today">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Расписание на сегодня</h2>
                <span class="text-muted">{{ current_week_day }}, {{ today|date:"d.m.Y" }}</span>
            </div>
            
            {% if today_schedule %}
                <div class="schedule-list">
                    {% for lesson in today_schedule %}
                    <div class="lesson-row">
                        <div class="lesson-number">{{ lesson.lesson_number }} урок</div>
                        <div class="lesson-subject">{{ lesson.subject.name }}</div>
                        <div class="lesson-teacher">{{ lesson.teacher.get_full_name }}</div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state-custom">
                    <div class="empty-icon">
                        <i class="bi bi-calendar-x"></i>
                    </div>
                    <div class="empty-title">Нет уроков на сегодня</div>
                    <div class="empty-text">Сегодня выходной или нет расписания</div>
                </div>
            {% endif %}
        </div>

        <!-- 3. ОБЪЯВЛЕНИЯ -->
        <div class="announcements-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Объявления</h2>
                <div class="d-flex align-items-center gap-3">
                    {% if announcements_count > 0 %}
                    <span class="badge bg-primary">{{ announcements_count }} новых</span>
                    {% endif %}
                    <a href="{% url 'student_announcements' %}" class="view-all-link">
                        Все объявления
                        <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
            
            {% if announcements %}
                <div class="announcements-list">
                    {% for announcement in announcements %}
                    <div class="announcement-card" 
                         onclick="window.location.href='{% url 'student_announcements' %}#announcement-{{ announcement.id }}'">
                        <div class="announcement-header">
                            <div>
                                <div class="announcement-title">{{ announcement.title }}</div>
                                <div class="announcement-meta">
                                    {{ announcement.created_at|date:"d.m.Y H:i" }}
                                    • {{ announcement.author.get_full_name }}
                                </div>
                            </div>
                            <span class="{% if announcement.is_for_all %}badge-general{% else %}badge-class{% endif %}">
                                {% if announcement.is_for_all %}Общее{% else %}Классное{% endif %}
                            </span>
                        </div>
                        <div class="announcement-content">
                            {{ announcement.content|truncatechars:150 }}
                        </div>
                        <div class="announcement-footer">
                            <span>
                                {% if announcement.student_group %}
                                    Для {{ announcement.student_group.name }}
                                {% else %}
                                    Для всех классов
                                {% endif %}
                            </span>
                            <span>
                                {{ announcement.created_at|timesince }} назад
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state-custom">
                    <div class="empty-icon">
                        <i class="bi bi-megaphone"></i>
                    </div>
                    <div class="empty-title">Нет объявлений</div>
                    <div class="empty-text">Новых объявлений пока нет</div>
                </div>
            {% endif %}
        </div>

        <!-- 4. ПОСЛЕДНИЕ ОЦЕНКИ -->
        <div class="grades-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Последние оценки</h2>
                <a href="{% url 'student_grades' %}" class="view-all-link">
                    Все оценки
                    <i class="bi bi-arrow-right"></i>
                </a>
            </div>
            
            {% if recent_grades %}
                <div class="grades-list">
                    {% for grade in recent_grades %}
                    <div class="grade-item">
                        <div class="grade-value 
                            {% if grade.value >= 4.5 %}grade-value-excellent
                            {% elif grade.value >= 3.5 %}grade-value-good
                            {% elif grade.value >= 2.5 %}grade-value-average
                            {% else %}grade-value-poor{% endif %}">
                            {{ grade.value }}
                        </div>
                        <div class="grade-info">
                            <div class="grade-subject">{{ grade.subject.name }}</div>
                            <div class="grade-details">
                                {{ grade.get_grade_type_display }}
                                • {{ grade.date|date:"d.m.Y" }}
                            </div>
                            <div class="grade-teacher">
                                {{ grade.teacher.get_full_name }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state-custom">
                    <div class="empty-icon">
                        <i class="bi bi-journal-check"></i>
                    </div>
                    <div class="empty-title">Нет оценок</div>
                    <div class="empty-text">Оценки еще не выставлялись</div>
                </div>
            {% endif %}
        </div>

        <!-- 5. ДОМАШНИЕ ЗАДАНИЯ -->
        <div class="homework-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Домашние задания</h2>
                <a href="{% url 'student_homework' %}" class="view-all-link">
                    Все задания
                    <i class="bi bi-arrow-right"></i>
                </a>
            </div>
            
            {% if homeworks %}
                <div class="homework-list">
                    {% for hw in homeworks %}
                    <div class="homework-item" onclick="window.location.href='{% url 'homework_detail' hw.id %}'">
                        <div class="homework-icon">
                            <i class="bi bi-journal-text"></i>
                        </div>
                        <div class="homework-content">
                            <div class="homework-title">{{ hw.title }}</div>
                            <div class="homework-description">{{ hw.description|truncatechars:100 }}</div>
                            <div class="homework-meta">
                                <span class="homework-subject">{{ hw.schedule_lesson.subject.name }}</span>
                                <span class="homework-deadline {% if hw.due_date < today %}urgent{% endif %}">
                                    Сдать до: {{ hw.due_date|date:"d.m.Y H:i" }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state-custom">
                    <div class="empty-icon">
                        <i class="bi bi-journal-text"></i>
                    </div>
                    <div class="empty-title">Нет активных заданий</div>
                    <div class="empty-text">Все задания выполнены или срок сдачи еще не наступил</div>
                </div>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Анимация при наведении
    document.querySelectorAll('.announcement-card, .homework-item').forEach(item => {
        item.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
    
    // Подсветка срочных заданий
    document.querySelectorAll('.homework-deadline.urgent').forEach(item => {
        item.closest('.homework-item').style.borderColor = '#dc3545';
    });
});
</script>
{% endblock %}