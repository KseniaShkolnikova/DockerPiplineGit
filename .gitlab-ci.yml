stages:
  - build
  - lint
  - test

variables:
  DJANGO_SETTINGS_MODULE: "project.settings"
  VENV_PATH: ".venv"

# 1. Проверка сборки проекта
build-validation:
  stage: build
  before_script:
    - python3 -m venv $VENV_PATH
    - source $VENV_PATH/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - source $VENV_PATH/bin/activate
    - python3 manage.py check
    - echo "✅ Проект успешно собирается"

# 2. Проверка линтером
code-lint:
  stage: lint
  before_script:
    - python3 -m venv $VENV_PATH
    - source $VENV_PATH/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - source $VENV_PATH/bin/activate
    - find . -name "*.py" -not -path "./$VENV_PATH/*" -exec python3 -m py_compile {} \;
    - echo "✅ Синтаксических ошибок не найдено"


# 3. Функциональная задача: Проверка моделей MPTed_base
mpted-models-check:
  stage: test
  before_script:
    - python3 -m venv $VENV_PATH
    - source $VENV_PATH/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - source $VENV_PATH/bin/activate
    - echo "=== ПРОВЕРКА МОДЕЛЕЙ MPTed_base ==="
    
    # Создаем простой Python скрипт для проверки
    - |
      cat > check_mpted.py << 'EOF'
      try:
          from api import models
          print("✅ Приложение MPTed_base импортировано")
          
          # Пробуем получить список моделей
          import inspect
          model_classes = []
          for name, obj in inspect.getmembers(models):
              if inspect.isclass(obj) and hasattr(obj, '_meta'):
                  model_classes.append(name)
          
          if model_classes:
              print(f"✅ Найдены модели: {', '.join(model_classes)}")
          else:
              print("⚠️ Модели не найдены")
              
      except ImportError as e:
          print(f"❌ Ошибка импорта: {e}")
      except Exception as e:
          print(f"⚠️ Другая ошибка: {e}")
      EOF
    
    - python3 check_mpted.py
    - rm check_mpted.py

# 4. Функциональная задача 2: Сбор статических файлов
static-files-collect:
  stage: test
  before_script:
    - python3 -m venv $VENV_PATH
    - source $VENV_PATH/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - source $VENV_PATH/bin/activate
    - mkdir -p staticfiles
    - python3 manage.py collectstatic --noinput
    - echo "✅ Собрано статических файлов:"
    - du -sh staticfiles/