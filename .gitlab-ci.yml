stages:
  - build
  - lint
  - test

variables:
  DJANGO_SETTINGS_MODULE: "project.settings"
  VENV_PATH: ".venv"

# 1. Проверка сборки проекта
build-validation:
  stage: build
  before_script:
    - apt-get update && apt-get install -y postgresql libpq-dev python3-dev gcc
    - service postgresql start
    - sleep 2
    - psql -U postgres -c "\l" || echo "PostgreSQL не запущен"
    - psql -d mpted -U postgres -c "SELECT 1;" || echo "БД mpted не доступна"
    - python3 -m venv $VENV_PATH
    - source $VENV_PATH/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - source $VENV_PATH/bin/activate
    - echo "=== ПРОВЕРКА СБОРКИ ПРОЕКТА ==="
    - python3 manage.py check
    - echo "✅ Проект успешно собирается"

# 2. Проверка линтером
code-lint:
  stage: lint
  before_script:
    - apt-get update && apt-get install -y postgresql libpq-dev python3-dev gcc
    - service postgresql start
    - sleep 2
    - python3 -m venv $VENV_PATH
    - source $VENV_PATH/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - source $VENV_PATH/bin/activate
    - echo "=== ПРОВЕРКА СИНТАКСИСА ==="
    - find . -name "*.py" -not -path "./$VENV_PATH/*" -exec python3 -m py_compile {} \;
    - echo "✅ Синтаксических ошибок не найдено"


# 4. Функциональная задача 2: Сбор статических файлов
static-files-collect:
  stage: test
  before_script:
    - apt-get update && apt-get install -y postgresql libpq-dev python3-dev gcc
    - service postgresql start
    - sleep 2
    - python3 -m venv $VENV_PATH
    - source $VENV_PATH/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - source $VENV_PATH/bin/activate
    - echo "=== СБОР СТАТИЧЕСКИХ ФАЙЛОВ ==="
    - mkdir -p staticfiles
    - python3 manage.py collectstatic --noinput
    - echo "✅ Собрано статических файлов:"
    - du -sh staticfiles/
    - echo "Количество файлов:"
    - find staticfiles/ -type f | wc -l

# 3. Функциональная задача 1: Проверка подключения к БД
database-connection:
  stage: test
  before_script:
    - apt-get update && apt-get install -y postgresql libpq-dev python3-dev gcc
    - service postgresql start
    - sleep 2
    - psql -U postgres -c "\l" || echo "PostgreSQL не запущен"
    - psql -d mpted -U postgres -c "SELECT 1;" || echo "БД mpted не доступна"
    - python3 -m venv $VENV_PATH
    - source $VENV_PATH/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - source $VENV_PATH/bin/activate
    - echo "=== ПРОВЕРКА ПОДКЛЮЧЕНИЯ К БАЗЕ ДАННЫХ ==="
    - python3 -c "
import os
import django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'project.settings')
django.setup()

from django.db import connection

print('Проверка подключения к PostgreSQL...')
try:
    with connection.cursor() as cursor:
        cursor.execute('SELECT version();')
        version = cursor.fetchone()
        print(f'✅ Подключение успешно! Версия: {version[0]}')
except Exception as e:
    print(f'❌ Ошибка подключения к БД: {e}')
    exit(1)
"
