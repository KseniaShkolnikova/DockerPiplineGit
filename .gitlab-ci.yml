stages:
  - build
  - lint
  - test

variables:
  DJANGO_SETTINGS_MODULE: "project.settings"
  VENV_PATH: ".venv"

# 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
# build-validation:
#   stage: build
#   before_script:
#     - python3 -m venv $VENV_PATH
#     - source $VENV_PATH/bin/activate
#     - pip install --upgrade pip
#     - pip install -r requirements.txt
#   script:
#     - source $VENV_PATH/bin/activate
#     - python3 manage.py check
#     - echo "âœ… ÐŸÑ€Ð¾ÐµÐºÑ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ÑÑ"

# # 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¸Ð½Ñ‚ÐµÑ€Ð¾Ð¼
# code-lint:
#   stage: lint
#   before_script:
#     - python3 -m venv $VENV_PATH
#     - source $VENV_PATH/bin/activate
#     - pip install --upgrade pip
#     - pip install -r requirements.txt
#   script:
#     - source $VENV_PATH/bin/activate
#     - find . -name "*.py" -not -path "./$VENV_PATH/*" -exec python3 -m py_compile {} \;
#     - echo "âœ… Ð¡Ð¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾"


# 3. Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð°Ð´Ð°Ñ‡Ð°: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ MPTed_base
mpted-models-check:
  stage: test
  before_script:
    - python3 -m venv $VENV_PATH
    - source $VENV_PATH/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - source $VENV_PATH/bin/activate
    - echo "=== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ÐœÐžÐ”Ð•Ð›Ð•Ð™ MPTed_base ==="
    
    # ÐŸÑ€Ð¾ÑÑ‚ÐµÐ¹ÑˆÐ¸Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚
    - |
      cat > check_mpted.py << 'EOF'
      import os, django
      os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'project.settings')
      django.setup()
      
      from django.apps import apps
      
      try:
          app = apps.get_app_config('api')
          models = list(app.get_models())  # Ð‘Ñ‹Ð»Ð¾: models = app.get_models()          
          if models:
              names = [m.__name__ for m in models]
              print(f"âœ… ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹: {len(models)}")
              print(f"ðŸ“‹ Ð¡Ð¿Ð¸ÑÐ¾Ðº: {', '.join(names)}")
          else:
              print("âš ï¸ ÐœÐ¾Ð´ÐµÐ»ÐµÐ¹ Ð½ÐµÑ‚")
      except Exception as e:
          print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {e}")
      EOF
    
    - python3 check_mpted.py
    - rm check_mpted.py

# # 4. Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð°Ð´Ð°Ñ‡Ð° 2: Ð¡Ð±Ð¾Ñ€ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
# static-files-collect:
#   stage: test
#   before_script:
#     - python3 -m venv $VENV_PATH
#     - source $VENV_PATH/bin/activate
#     - pip install --upgrade pip
#     - pip install -r requirements.txt
#   script:
#     - source $VENV_PATH/bin/activate
#     - mkdir -p staticfiles
#     - python3 manage.py collectstatic --noinput
#     - echo "âœ… Ð¡Ð¾Ð±Ñ€Ð°Ð½Ð¾ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²:"
#     - du -sh staticfiles/