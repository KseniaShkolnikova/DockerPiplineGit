stages:
  - build
  - lint
  - test

variables:
  DJANGO_SETTINGS_MODULE: "project.settings"
  VENV_PATH: ".venv"




database-check:
  stage: test
  script:
    - echo "=== РЕАЛЬНАЯ ПРОВЕРКА POSTGRESQL ==="
    
    # 1. Проверяем что PostgreSQL слушает порт 5432
    - if netstat -tuln | grep -q ":5432 "; then
        echo "✅ PostgreSQL слушает порт 5432";
      else
        echo "❌ PostgreSQL НЕ слушает порт 5432";
        exit 1;
      fi
    
    # 2. Проверяем что можем подключиться к серверу
    - if pg_isready -h localhost -p 5432; then
        echo "✅ PostgreSQL принимает подключения";
      else
        echo "❌ PostgreSQL НЕ принимает подключения";
        exit 1;
      fi
    
    # 3. Проверяем что БД 'mpted' существует
    - if sudo -u postgres psql -l | grep -q mpted; then
        echo "✅ БД 'mpted' существует";
      else
        echo "❌ БД 'mpted' НЕ существует";
        exit 1;
      fi
    
    # 4. Проверяем что можем подключиться к БД 'mpted'
    - if sudo -u postgres psql -d mpted -c "SELECT 1;" >/dev/null 2>&1; then
        echo "✅ Можем подключиться к БД 'mpted'";
      else
        echo "❌ НЕ можем подключиться к БД 'mpted'";
        exit 1;
      fi
    
    # 5. Проверяем базовые таблицы (если знаешь какую-то таблицу)
    - if sudo -u postgres psql -d mpted -c "\dt" 2>/dev/null | grep -q "auth_user"; then
        echo "✅ Таблица 'auth_user' существует (пример)";
      else
        echo "⚠️  Таблицы могут быть пустыми";
      fi
    
    - echo "✅ PostgreSQL полностью настроен и работает!"
