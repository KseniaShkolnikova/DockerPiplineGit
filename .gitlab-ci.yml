stages:
  - build
  - lint
  - test

variables:
  DJANGO_SETTINGS_MODULE: "project.settings"
  VENV_PATH: ".venv"


# 3. Функциональная задача 1: Проверка подключения к БД
database-check:
  stage: test
  script:
    - echo "=== ПРОВЕРКА РЕАЛЬНОЙ БД mpted ==="
    
    # Устанавливаем пароль как в settings.py
    - export PGPASSWORD=1
    
    # Пробуем подключиться как в Django настройках
    - if psql -h 127.0.0.1 -p 5432 -U postgres -d mpted -c "SELECT 1;"; then
        echo "✅ Подключение к БД mpted успешно!";
        
        # Проверяем таблицы
        - echo "Таблицы в БД:";
        - psql -h 127.0.0.1 -p 5432 -U postgres -d mpted -c "\dt";
        
      else
        echo "❌ Не удалось подключиться с паролем";
        echo "Пробуем через sudo...";
        
        - if sudo -u postgres psql -d mpted -c "SELECT 1;"; then
            echo "✅ Работает через sudo";
          else
            echo "❌ Совсем не работает";
            exit 1;
          fi
      fi
