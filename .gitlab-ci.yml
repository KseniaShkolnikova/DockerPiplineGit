stages:
  - build
  - lint
  - test

variables:
  DJANGO_SETTINGS_MODULE: "project.settings"
  VENV_PATH: ".venv"

# 1. Проверка сборки проекта
build-validation:
  stage: build
  before_script:
    - python3 -m venv $VENV_PATH
    - source $VENV_PATH/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - source $VENV_PATH/bin/activate
    - python3 manage.py check
    - echo "✅ Проект успешно собирается"

# 2. Проверка линтером
code-lint:
  stage: lint
  before_script:
    - python3 -m venv $VENV_PATH
    - source $VENV_PATH/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - source $VENV_PATH/bin/activate
    - find . -name "*.py" -not -path "./$VENV_PATH/*" -exec python3 -m py_compile {} \;
    - echo "✅ Синтаксических ошибок не найдено"

# 3. Функциональная задача 1: Проверка подключения к БД
database-connection:
  stage: test
  script:
    - echo "=== ПРОВЕРКА И ЗАПУСК POSTGRESQL ==="
    
    # 1. Проверь статус PostgreSQL
    - systemctl status postgresql 2>/dev/null || echo "PostgreSQL служба не найдена"
    
    # 2. Запусти PostgreSQL если не запущен
    - service postgresql start 2>/dev/null || systemctl start postgresql 2>/dev/null || echo "Не удалось запустить PostgreSQL"
    
    # 3. Подожди 2 секунды
    - sleep 2
    
    # 4. Проверь подключение к созданной БД mpted
    - psql -U postgres -d mpted -c "SELECT 1;" 2>/dev/null && echo "✅ БД mpted доступна" || echo "❌ БД mpted недоступна"
    
    # 5. Альтернативная проверка - просто что процесс есть
    - pgrep postgres && echo "✅ PostgreSQL процесс работает" || echo "❌ PostgreSQL процесс не найден"
# 4. Функциональная задача 2: Сбор статических файлов
static-files-collect:
  stage: test
  before_script:
    - python3 -m venv $VENV_PATH
    - source $VENV_PATH/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - source $VENV_PATH/bin/activate
    - mkdir -p staticfiles
    - python3 manage.py collectstatic --noinput
    - echo "✅ Собрано статических файлов:"
    - du -sh staticfiles/